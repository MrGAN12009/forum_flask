{% extends "base.html" %}

{% block title %}Чат с {{ recipient.username }} - Форум{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <a href="{{ url_for('chat.index') }}" class="btn btn-sm btn-light me-3">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <img src="{{ url_for('static', filename='uploads/avatars/' + recipient.avatar) }}" 
                         alt="{{ recipient.username }}" class="avatar-sm me-2">
                    <div>
                        <h5 class="mb-0">{{ recipient.username }}</h5>
                        <small id="typing-indicator" class="text-white-50" style="display: none;">
                            печатает...
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="card-body" id="messages-container" 
                 style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                <div id="messages">
                    {% for message in messages %}
                    <div class="mb-3 {% if message.sender_id == current_user.id %}text-end{% endif %}">
                        <div class="d-inline-block" style="max-width: 70%;">
                            <div class="card {% if message.sender_id == current_user.id %}bg-primary text-white{% else %}bg-white{% endif %}">
                                <div class="card-body py-2 px-3">
                                    {% if message.sender_id != current_user.id %}
                                    <small class="text-muted">{{ message.sender.username }}</small>
                                    {% endif %}
                                    <p class="mb-1">{{ message.content }}</p>
                                    {% if message.image %}
                                    <img src="{{ url_for('static', filename='uploads/chat/' + message.image) }}" 
                                         alt="Image" class="post-image mt-2" style="max-width: 100%;">
                                    {% endif %}
                                    <small class="{% if message.sender_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                        {{ message.created_at.strftime('%H:%M') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="card-footer">
                <form id="message-form">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" 
                               placeholder="Напишите сообщение..." required>
                        <label class="btn btn-outline-secondary" for="image-input">
                            <i class="bi bi-image"></i>
                        </label>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Отправить
                        </button>
                    </div>
                    <div id="image-preview" style="display: none;" class="mt-2">
                        <img id="preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px;">
                        <button type="button" class="btn btn-sm btn-danger ms-2" id="remove-image">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const recipientId = {{ recipient.id }};
    const currentUserId = {{ current_user.id }};
    const messagesContainer = document.getElementById('messages-container');
    const messagesDiv = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const typingIndicator = document.getElementById('typing-indicator');
    
    let selectedImageData = null;
    let typingTimeout = null;

    // Автопрокрутка вниз
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    scrollToBottom();

    // Присоединение к чату
    socket.emit('join_chat', { recipient_id: recipientId });
    
    // Отметка сообщений как прочитанных
    socket.emit('mark_read', { sender_id: recipientId });

    // Обработка нового сообщения
    socket.on('new_message', function(data) {
        const isFromMe = data.sender_id === currentUserId;
        const messageHtml = `
            <div class="mb-3 ${isFromMe ? 'text-end' : ''}">
                <div class="d-inline-block" style="max-width: 70%;">
                    <div class="card ${isFromMe ? 'bg-primary text-white' : 'bg-white'}">
                        <div class="card-body py-2 px-3">
                            ${!isFromMe ? `<small class="text-muted">${data.sender_username}</small>` : ''}
                            <p class="mb-1">${data.content}</p>
                            ${data.image ? `<img src="/static/uploads/chat/${data.image}" alt="Image" class="post-image mt-2" style="max-width: 100%;">` : ''}
                            <small class="${isFromMe ? 'text-white-50' : 'text-muted'}">
                                ${new Date(data.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        scrollToBottom();
        
        // Отмечаем как прочитанное если это не наше сообщение
        if (!isFromMe) {
            socket.emit('mark_read', { sender_id: recipientId });
        }
    });

    // Отправка сообщения
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        if (!content) return;
        
        socket.emit('send_message', {
            recipient_id: recipientId,
            content: content,
            image: selectedImageData
        });
        
        messageInput.value = '';
        selectedImageData = null;
        imagePreview.style.display = 'none';
    });

    // Обработка изображения
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageData = e.target.result;
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Удаление изображения
    document.getElementById('remove-image').addEventListener('click', function() {
        selectedImageData = null;
        imageInput.value = '';
        imagePreview.style.display = 'none';
    });

    // Индикатор печатает
    messageInput.addEventListener('input', function() {
        socket.emit('typing', { recipient_id: recipientId });
    });

    socket.on('user_typing', function(data) {
        if (data.user_id === recipientId) {
            typingIndicator.style.display = 'block';
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(function() {
                typingIndicator.style.display = 'none';
            }, 2000);
        }
    });

    // Покидаем чат при выходе
    window.addEventListener('beforeunload', function() {
        socket.emit('leave_chat', { recipient_id: recipientId });
    });
</script>
{% endblock %}

